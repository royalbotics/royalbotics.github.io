<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ro&Bot™ Weather</title>
  <meta name="description" content="Comprehensive weather forecast by Ro&Bot Royal Botics" />
  <meta name="author" content="Ro&Bot Royal Botics" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="icon" href="/favicon.png" type="image/png" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to bottom, #000000 0%, #3b0056 100%);
      color: #e5e5e5;
    }

    nav {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      padding: 15px 30px;
      display: flex;
      justify-content: flex-end;
      gap: 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    nav a {
      color: #e5e5e5;
      text-decoration: none;
      font-size: 1rem;
      transition: 0.3s;
    }

    nav a:hover {
      color: #a100f2;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 40px 20px 80px;
      text-align: left;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 30px;
      text-align: center;
    }

    h2 {
      font-size: 1.6rem;
      margin-top: 50px;
      color: #fff;
      border-bottom: 2px solid #a100f2;
      padding-bottom: 6px;
    }

    .location-bar {
      text-align: center;
      margin-bottom: 30px;
      font-weight: 600;
      color: #d183f7;
      font-size: 1.2rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    button, input, select {
      font-family: 'Poppins', sans-serif;
    }

    button {
      background: #a100f2;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }

    button:hover {
      background: #d183f7;
    }

    input[type="text"] {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #a100f2;
      background: rgba(0,0,0,0.3);
      color: #e5e5e5;
      outline: none;
      min-width: 200px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      border-color: #d183f7;
    }

    select {
      background: rgba(0,0,0,0.3);
      border: 1px solid #a100f2;
      color: #e5e5e5;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 1rem;
      cursor: pointer;
      min-width: 200px;
    }

    .error {
      color: #ff4c4c;
      text-align: center;
      margin-top: 10px;
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 20px;
      font-size: 1rem;
      margin-top: 10px;
      margin-bottom: 40px;
    }

    .info-label {
      opacity: 0.7;
    }

    .info-value {
      font-weight: 600;
      color: #a100f2;
      text-align: right;
    }

    .forecast {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px;
      margin-top: 10px;
    }

    .forecast-day {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #a100f222;
      border-radius: 8px;
      padding: 15px 10px;
      text-align: center;
      box-shadow: 0 0 10px #a100f2aa;
      color: #e5e5e5;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .forecast-day .label {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-bottom: 6px;
    }

    .forecast-day .value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #a100f2;
      margin-bottom: 6px;
    }

    footer {
      text-align: center;
      padding: 20px;
      background: #111;
      font-size: 0.9rem;
      color: #888;
      margin-top: 60px;
    }
  </style>
</head>
<body>

  <nav>
    <a href="index.html">Home</a>
    <a href="shop.html">Shop</a>
    <a href="samanthai.html">SamanthAI</a>
    <a href="mission.html">Mission</a>
    <a href="tof.html">Terms</a>
    <a href="contact.html">Contact</a>
    <a href="research.html">Research</a>
  </nav>

  <div class="container">
    <h1>Ro&Bot™ Weather</h1>

    <div class="location-bar" id="location-bar">
      <span id="location-name">Locating...</span>
      <button id="change-location-btn">Change Location</button>
      <select id="saved-locations" title="Saved locations" style="display:none;"></select>
      <button id="remove-location-btn" style="display:none; background:#ff4c4c; border:none; color:white; border-radius:6px; padding:8px 12px; margin-left:10px; cursor:pointer;">Remove</button>
    </div>

    <div id="search-area" style="text-align:center; margin-bottom:30px; display:none;">
      <input type="text" id="location-search-input" placeholder="Enter city or place name" />
      <button id="search-location-btn">Search</button>
      <button id="cancel-search-btn" style="background:#444; margin-left:10px;">Cancel</button>
      <div class="error" id="search-error"></div>
    </div>

    <h2>Current Weather</h2>
    <div class="info-grid" id="current-info"></div>

    <h2>7-Day Forecast</h2>
    <div class="forecast" id="daily-forecast"></div>
  </div>

  <footer>
    &copy; 2025 Ro&Bot Royal Botics. All Rights Reserved.
  </footer>

  <script>
    const STORAGE_KEY = 'robot_saved_locations';

    function saveLocation(name, lat, lon) {
      let locations = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      const exists = locations.some(l => l.name.toLowerCase() === name.toLowerCase() || (l.lat === lat && l.lon === lon));
      if (!exists) {
        locations.push({name, lat, lon});
        localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
      }
    }

    function getSavedLocations() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }

    const savedSelect = document.getElementById('saved-locations');
    const removeBtn = document.getElementById('remove-location-btn');

    function updateRemoveButtonVisibility() {
      const locations = getSavedLocations();
      if(locations.length > 0) {
        removeBtn.style.display = 'inline-block';
      } else {
        removeBtn.style.display = 'none';
      }
    }

    function populateSavedLocationsDropdown() {
      const locations = getSavedLocations();
      if (locations.length === 0) {
        savedSelect.style.display = 'none';
        removeBtn.style.display = 'none';
        return;
      }
      savedSelect.style.display = 'inline-block';
      savedSelect.innerHTML = '<option value="">Select Saved Location</option>';
      locations.forEach((loc, i) => {
        savedSelect.innerHTML += `<option value="${i}">${loc.name}</option>`;
      });
      updateRemoveButtonVisibility();
      removeBtn.disabled = true;
    }

    async function fetchWeatherByCoords(lat, lon, name) {
      try {
        document.getElementById('search-error').textContent = '';
        document.getElementById('location-name').textContent = name || `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
        const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode,windspeed_10m_max,uv_index_max,precipitation_sum,sunrise,sunset,apparent_temperature_max,apparent_temperature_min,windgusts_10m_max&timezone=auto`;
        const res = await fetch(weatherUrl);
        const data = await res.json();

        if(!data.current_weather) throw new Error("Weather data not available");

        const current = data.current_weather;
        const daily = data.daily;

        const currentInfo = {
          "Temperature": `${current.temperature} °C`,
          "Wind Speed": `${current.windspeed} km/h`,
          "Wind Direction": `${current.winddirection}°`,
          "Weather Code": current.weathercode,
          "UV Index (Max)": daily.uv_index_max[0],
          "Precipitation": `${daily.precipitation_sum[0]} mm`,
          "Sunrise": daily.sunrise[0].split("T")[1],
          "Sunset": daily.sunset[0].split("T")[1],
          "Apparent Temp. Max": `${daily.apparent_temperature_max[0]} °C`,
          "Apparent Temp. Min": `${daily.apparent_temperature_min[0]} °C`,
          "Wind Gusts Max": `${daily.windgusts_10m_max[0]} km/h`
        };

        const infoEl = document.getElementById('current-info');
        infoEl.innerHTML = '';
        for (const [label, value] of Object.entries(currentInfo)) {
          infoEl.innerHTML += `
            <div class="info-label">${label}</div>
            <div class="info-value">${value}</div>`;
        }

        const forecastEl = document.getElementById('daily-forecast');
        forecastEl.innerHTML = '';
        for (let i = 0; i < daily.time.length; i++) {
          forecastEl.innerHTML += `
            <div class="forecast-day">
              <div class="label">${daily.time[i]}</div>
              <div class="value">${daily.temperature_2m_min[i]} - ${daily.temperature_2m_max[i]} °C</div>
              <div class="label">Rain: ${daily.precipitation_sum[i]} mm</div>
              <div class="label">UV Index: ${daily.uv_index_max[i]}</div>
              <div class="label">Wind Speed: ${daily.windspeed_10m_max ? daily.windspeed_10m_max[i] + ' km/h' : 'N/A'}</div>
            </div>`;
        }
      } catch (err) {
        document.getElementById('search-error').textContent = 'Error fetching weather data.';
        console.error(err);
      }
    }

    async function detectLocation() {
      try {
        const res = await fetch('https://ipapi.co/json/');
        const loc = await res.json();
        if (loc.latitude && loc.longitude) {
          fetchWeatherByCoords(loc.latitude, loc.longitude, `${loc.city}, ${loc.country_name}`);
        } else {
          throw new Error("Location unavailable");
        }
      } catch (e) {
        document.getElementById('location-name').textContent = 'Unable to detect location.';
      }
    }

    async function geocodeLocation(name) {
      try {
        document.getElementById('search-error').textContent = '';
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(name)}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.length === 0) {
          document.getElementById('search-error').textContent = 'Location not found.';
          return null;
        }
        return {lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), display_name: data[0].display_name};
      } catch {
        document.getElementById('search-error').textContent = 'Error during geocoding.';
        return null;
      }
    }

    // UI elements
    const changeBtn = document.getElementById('change-location-btn');
    const searchArea = document.getElementById('search-area');
    const searchInput = document.getElementById('location-search-input');
    const searchBtn = document.getElementById('search-location-btn');
    const cancelBtn = document.getElementById('cancel-search-btn');

    changeBtn.onclick = () => {
      searchArea.style.display = 'block';
      savedSelect.style.display = 'inline-block';
      changeBtn.style.display = 'none';
      removeBtn.style.display = savedSelect.options.length > 1 ? 'inline-block' : 'none';
    };

    cancelBtn.onclick = () => {
      searchArea.style.display = 'none';
      savedSelect.style.display = 'none';
      changeBtn.style.display = 'inline-block';
      removeBtn.style.display = 'none';
      document.getElementById('search-error').textContent = '';
      searchInput.value = '';
      savedSelect.value = '';
    };

    searchBtn.onclick = async () => {
      const query = searchInput.value.trim();
      if (!query) {
        document.getElementById('search-error').textContent = 'Please enter a location.';
        return;
      }
      const result = await geocodeLocation(query);
      if (result) {
        fetchWeatherByCoords(result.lat, result.lon, result.display_name);
        saveLocation(result.display_name, result.lat, result.lon);
        populateSavedLocationsDropdown();
        cancelBtn.onclick();
      }
    };

    savedSelect.onchange = () => {
      const idx = savedSelect.value;
      if (idx === "") {
        removeBtn.disabled = true;
        return;
      }
      removeBtn.disabled = false;
      const loc = getSavedLocations()[idx];
      if (loc) {
        fetchWeatherByCoords(loc.lat, loc.lon, loc.name);
      }
    };

    removeBtn.onclick = () => {
      const idx = savedSelect.value;
      if (idx === "") return;
      let locations = getSavedLocations();
      locations.splice(idx, 1);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
      populateSavedLocationsDropdown();
      removeBtn.disabled = true;
      savedSelect.value = '';
      if (locations.length > 0) {
        // Load first saved location by default
        fetchWeatherByCoords(locations[0].lat, locations[0].lon, locations[0].name);
      } else {
        detectLocation();
      }
    };

    // On load
    window.onload = () => {
      populateSavedLocationsDropdown();
      const saved = getSavedLocations();
      if (saved.length > 0) {
        fetchWeatherByCoords(saved[0].lat, saved[0].lon, saved[0].name);
      } else {
        detectLocation();
      }
    };
  </script>

</body>
</html>
