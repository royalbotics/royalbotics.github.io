<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ro&Bot™ Weather</title>
  <meta name="description" content="Comprehensive weather forecast by Ro&Bot Royal Botics" />
  <meta name="author" content="Ro&Bot Royal Botics" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <link rel="icon" href="/favicon.png" type="image/png" />

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to bottom, #000000 0%, #3b0056 100%);
      color: #e5e5e5;
    }

    nav {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(10px);
      padding: 15px 30px;
      display: flex;
      justify-content: flex-end;
      gap: 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    nav a {
      color: #e5e5e5;
      text-decoration: none;
      font-size: 1rem;
      transition: 0.3s;
    }

    nav a:hover {
      color: #a100f2;
    }

    .container {
      max-width: 900px;
      margin: auto;
      padding: 40px 20px 80px;
      text-align: left;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 30px;
      text-align: center;
    }

    h2 {
      font-size: 1.6rem;
      margin-top: 50px;
      color: #fff;
      border-bottom: 2px solid #a100f2;
      padding-bottom: 6px;
    }

    /* Location picker container */
    .location-bar {
      background: rgba(255 255 255 / 0.1);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      max-width: 720px;
      margin: 0 auto 40px auto;
      box-shadow: 0 0 15px #a100f2aa;
      font-weight: 600;
      color: #d183f7;
      font-size: 1.2rem;
      user-select: none;
    }

    #location-name {
      font-weight: 700;
      font-size: 1.3rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 250px;
    }

    button, input, select {
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      padding: 10px 14px;
      cursor: pointer;
      transition: background-color 0.25s ease;
      user-select: none;
    }

    button {
      background-color: #a100f2;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 6px #a100f233;
      display: flex;
      align-items: center;
      gap: 8px;
      border-radius: 10px;
      min-width: 120px;
      justify-content: center;
    }

    button:hover {
      background-color: #d183f7;
    }

    button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }

    input[type="text"] {
      background: rgba(0, 0, 0, 0.3);
      color: #e5e5e5;
      border: 1.5px solid #a100f2;
      min-width: 250px;
      max-width: 300px;
      padding-left: 14px;
      font-weight: 500;
      outline-offset: 2px;
    }

    input[type="text"]:focus {
      border-color: #d183f7;
      background: rgba(0,0,0,0.5);
    }

    select {
      background: rgba(0,0,0,0.3);
      color: #e5e5e5;
      border: 1.5px solid #a100f2;
      min-width: 220px;
      max-width: 280px;
      font-weight: 600;
      cursor: pointer;
      padding: 10px 12px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, #d183f7 50%),
        linear-gradient(135deg, #d183f7 50%, transparent 50%),
        linear-gradient(to right, #4c007a, #a100f2);
      background-position:
        calc(100% - 20px) calc(1em + 2px),
        calc(100% - 15px) calc(1em + 2px),
        calc(100% - 2.5em) 0.75em;
      background-size: 5px 5px, 5px 5px, 1px 1.5em;
      background-repeat: no-repeat;
    }

    .error {
      color: #ff4c4c;
      text-align: center;
      margin-top: 10px;
      font-weight: 600;
      width: 100%;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 20px;
      font-size: 1rem;
      margin-top: 10px;
      margin-bottom: 40px;
    }

    .info-label {
      opacity: 0.7;
    }

    .info-value {
      font-weight: 600;
      color: #a100f2;
      text-align: right;
    }

    .forecast {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px;
      margin-top: 10px;
    }

    .forecast-day {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid #a100f222;
      border-radius: 8px;
      padding: 15px 10px;
      text-align: center;
      box-shadow: 0 0 10px #a100f2aa;
      color: #e5e5e5;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .forecast-day .label {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-bottom: 6px;
    }

    .forecast-day .value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #a100f2;
      margin-bottom: 6px;
    }

    footer {
      text-align: center;
      padding: 20px;
      background: #111;
      font-size: 0.9rem;
      color: #888;
      margin-top: 60px;
    }

    /* Search area style */
    #search-area {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      max-width: 720px;
      margin: 0 auto 40px auto;
    }

    #search-area input {
      flex-grow: 1;
      min-width: 220px;
      max-width: 350px;
    }

    #search-area button {
      min-width: 100px;
    }

    /* Icon styling inside buttons */
    .icon {
      width: 18px;
      height: 18px;
      stroke-width: 2.2;
    }
  </style>
</head>
<body>

  <nav>
    <a href="index.html">Home</a>
    <a href="shop.html">Shop</a>
    <a href="samanthai.html">SamanthAI</a>
    <a href="mission.html">Mission</a>
    <a href="tof.html">Terms</a>
    <a href="contact.html">Contact</a>
    <a href="research.html">Research</a>
  </nav>

  <div class="container">
    <h1>Ro&Bot™ Weather</h1>

    <div class="location-bar" id="location-bar">
      <span id="location-name" title="Current Location">Locating...</span>
      
      <!-- Change Location Button -->
      <button id="change-location-btn" title="Change Location">
        <i data-lucide="edit-2" class="icon"></i> Change
      </button>

      <!-- Saved locations dropdown -->
      <select id="saved-locations" title="Saved locations" style="display:none;"></select>

      <!-- Remove selected saved location -->
      <button id="remove-location-btn" title="Remove Selected Location" style="display:none; background:#ff4c4c;">
        <i data-lucide="trash-2" class="icon"></i> Remove
      </button>
    </div>

    <!-- Search area -->
    <div id="search-area" style="display:none;">
      <input type="text" id="location-search-input" placeholder="Enter city or place name" aria-label="Location search" />
      <button id="search-location-btn" title="Search Location">
        <i data-lucide="search" class="icon"></i> Search
      </button>
      <button id="cancel-search-btn" style="background:#444;" title="Cancel Location Search">
        <i data-lucide="x" class="icon"></i> Cancel
      </button>
    </div>

    <div class="error" id="search-error"></div>

    <h2>Current Weather</h2>
    <div class="info-grid" id="current-info"></div>

    <h2>7-Day Forecast</h2>
    <div class="forecast" id="daily-forecast"></div>
  </div>

  <footer>
    &copy; 2025 Ro&Bot Royal Botics. All Rights Reserved.
  </footer>

  <script>
    // Activate lucide icons
    lucide.replace();

    const STORAGE_KEY = 'robot_saved_locations';

    function saveLocation(name, lat, lon) {
      let locations = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      const exists = locations.some(l => l.name.toLowerCase() === name.toLowerCase() || (l.lat === lat && l.lon === lon));
      if (!exists) {
        locations.push({name, lat, lon});
        localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
      }
    }

    function getSavedLocations() {
      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }

    const savedSelect = document.getElementById('saved-locations');
    const removeBtn = document.getElementById('remove-location-btn');
    const locationNameEl = document.getElementById('location-name');
    const changeBtn = document.getElementById('change-location-btn');
    const searchArea = document.getElementById('search-area');
    const searchInput = document.getElementById('location-search-input');
    const searchBtn = document.getElementById('search-location-btn');
    const cancelSearchBtn = document.getElementById('cancel-search-btn');
    const errorEl = document.getElementById('search-error');

    function updateRemoveButtonVisibility() {
      const locations = getSavedLocations();
      if(locations.length > 0 && savedSelect.value !== "") {
        removeBtn.style.display = 'inline-flex';
        removeBtn.disabled = false;
      } else {
        removeBtn.style.display = 'none';
        removeBtn.disabled = true;
      }
    }

    function populateSavedLocationsDropdown() {
      const locations = getSavedLocations();
      if (locations.length === 0) {
        savedSelect.style.display = 'none';
        removeBtn.style.display = 'none';
        return;
      }
      savedSelect.style.display = 'inline-block';
      savedSelect.innerHTML = '<option value="">Select Saved Location</option>';
      locations.forEach((loc, i) => {
        savedSelect.innerHTML += `<option value="${i}">${loc.name}</option>`;
      });
      savedSelect.value = "";
      updateRemoveButtonVisibility();
    }

    async function fetchWeatherByCoords(lat, lon, name) {
      try {
        errorEl.textContent = '';
        locationNameEl.textContent = name || `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
        const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode,windspeed_10m_max,uv_index_max,precipitation_sum,sunrise,sunset,apparent_temperature_max,apparent_temperature_min,windgusts_10m_max&timezone=auto`;
        const res = await fetch(weatherUrl);
        const data = await res.json();

        if(!data.current_weather) throw new Error("Weather data not available");

        const current = data.current_weather;
        const daily = data.daily;

        const currentInfo = {
          "Temperature": `${current.temperature} °C`,
          "Wind Speed": `${current.windspeed} km/h`,
          "Wind Direction": `${current.winddirection}°`,
          "Weather Code": current.weathercode,
          "UV Index (Max)": daily.uv_index_max[0],
          "Precipitation": `${daily.precipitation_sum[0]} mm`,
          "Sunrise": daily.sunrise[0].split("T")[1],
          "Sunset": daily.sunset[0].split("T")[1],
          "Apparent Temp. Max": `${daily.apparent_temperature_max[0]} °C`,
          "Apparent Temp. Min": `${daily.apparent_temperature_min[0]} °C`,
          "Wind Gusts Max": `${daily.windgusts_10m_max[0]} km/h`
        };

        const infoEl = document.getElementById('current-info');
        infoEl.innerHTML = '';
        for (const [label, value] of Object.entries(currentInfo)) {
          infoEl.innerHTML += `
            <div class="info-label">${label}</div>
            <div class="info-value">${value}</div>`;
        }

        const forecastEl = document.getElementById('daily-forecast');
        forecastEl.innerHTML = '';
        for (let i = 0; i < daily.time.length; i++) {
          forecastEl.innerHTML += `
            <div class="forecast-day">
              <div class="label">${daily.time[i]}</div>
              <div class="value">Max: ${daily.temperature_2m_max[i]}°C</div>
              <div class="value">Min: ${daily.temperature_2m_min[i]}°C</div>
            </div>`;
        }
      } catch(err) {
        errorEl.textContent = err.message;
      }
    }

    // Search and select location handling

    changeBtn.addEventListener('click', () => {
      // Hide location bar controls except cancel button
      document.getElementById('location-bar').style.display = 'none';
      searchArea.style.display = 'flex';
      errorEl.textContent = '';
      searchInput.value = '';
      searchInput.focus();
    });

    cancelSearchBtn.addEventListener('click', () => {
      searchArea.style.display = 'none';
      document.getElementById('location-bar').style.display = 'flex';
      errorEl.textContent = '';
    });

    searchBtn.addEventListener('click', async () => {
      const query = searchInput.value.trim();
      if (!query) {
        errorEl.textContent = "Please enter a location name to search.";
        return;
      }
      errorEl.textContent = "Searching...";
      try {
        // Use Nominatim OpenStreetMap API to search for locations
        const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5`);
        const results = await geoRes.json();
        if (results.length === 0) {
          errorEl.textContent = "No results found.";
          return;
        }
        errorEl.textContent = "";
        // If multiple results, prompt user to pick (for simplicity pick first)
        const chosen = results[0];
        const displayName = chosen.display_name.split(',')[0];
        const lat = parseFloat(chosen.lat);
        const lon = parseFloat(chosen.lon);

        // Save location and update UI
        saveLocation(displayName, lat, lon);
        populateSavedLocationsDropdown();
        setSelectedLocation(lat, lon, displayName);
        searchArea.style.display = 'none';
        document.getElementById('location-bar').style.display = 'flex';
      } catch(e) {
        errorEl.textContent = "Error searching location. Try again.";
      }
    });

    // On saved location select
    savedSelect.addEventListener('change', () => {
      const idx = savedSelect.value;
      if(idx === "") return;
      const locations = getSavedLocations();
      const loc = locations[idx];
      if(loc) {
        setSelectedLocation(loc.lat, loc.lon, loc.name);
        updateRemoveButtonVisibility();
      }
    });

    // Remove selected saved location
    removeBtn.addEventListener('click', () => {
      const idx = savedSelect.value;
      if(idx === "") return;
      let locations = getSavedLocations();
      locations.splice(idx, 1);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(locations));
      populateSavedLocationsDropdown();
      locationNameEl.textContent = 'Location Removed';
      document.getElementById('current-info').innerHTML = '';
      document.getElementById('daily-forecast').innerHTML = '';
      updateRemoveButtonVisibility();
    });

    function setSelectedLocation(lat, lon, name) {
      locationNameEl.textContent = name;
      fetchWeatherByCoords(lat, lon, name);
    }

    // Initial Geolocation and setup
    async function initialize() {
      populateSavedLocationsDropdown();
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          setSelectedLocation(lat, lon, "Your Location");
        }, err => {
          // No geolocation or error fallback
          const saved = getSavedLocations();
          if(saved.length > 0) {
            setSelectedLocation(saved[0].lat, saved[0].lon, saved[0].name);
          } else {
            locationNameEl.textContent = "No Location Selected";
          }
        });
      } else {
        const saved = getSavedLocations();
        if(saved.length > 0) {
          setSelectedLocation(saved[0].lat, saved[0].lon, saved[0].name);
        } else {
          locationNameEl.textContent = "No Location Selected";
        }
      }
    }

    initialize();
  </script>
</body>
</html>
