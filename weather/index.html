function showTimeOnly(dateStr, elemId) {
  if (!dateStr) return;
  const date = new Date(dateStr);
  if (isNaN(date)) return;

  let hours = date.getHours();
  const minutes = date.getMinutes();
  hours = hours % 12 || 12; // 12-hour format
  const minutesStr = minutes < 10 ? '0' + minutes : minutes;

  document.getElementById(elemId).textContent = `${hours}:${minutesStr}`;
}

async function fetchWeatherByCoords(lat, lon, name) {
  try {
    document.getElementById('search-error').textContent = '';
    document.getElementById('location-name').textContent = name || `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;

    const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode,windspeed_10m_max,uv_index_max,precipitation_sum,sunrise,sunset,apparent_temperature_max,apparent_temperature_min,windgusts_10m_max,windspeed_10m_max&timezone=auto`;

    const res = await fetch(weatherUrl);
    const data = await res.json();

    if (!data.current_weather) throw new Error("Weather data not available");

    const current = data.current_weather;
    const daily = data.daily;

    // Format sunrise and sunset times
    showTimeOnly(daily.sunrise[0], 'sunrise-time');
    showTimeOnly(daily.sunset[0], 'sunset-time');

    // Moon phase calculation function
    function getMoonPhaseIndex(date) {
      const synodicMonth = 29.530588853;
      const knownNewMoon = new Date(Date.UTC(2000, 0, 6, 18, 14, 0));
      const diff = date.getTime() - knownNewMoon.getTime();
      const daysSinceNew = diff / (1000 * 60 * 60 * 24);
      const moonAge = daysSinceNew % synodicMonth;

      if (moonAge < 1.8457) return 0;
      if (moonAge < 5.53699) return 1;
      if (moonAge < 9.22831) return 2;
      if (moonAge < 12.91963) return 3;
      if (moonAge < 16.61096) return 4;
      if (moonAge < 20.30228) return 5;
      if (moonAge < 23.99361) return 6;
      if (moonAge < 27.68493) return 7;
      return 0;
    }

    const moonPhaseImages = [
      'new_moon.png',
      'waxing_crescent.png',
      'first_quarter.png',
      'waxing_gibbous.png',
      'full_moon.png',
      'waning_gibbous.png',
      'last_quarter.png',
      'waning_crescent.png'
    ];

    const moonPhaseNames = [
      'New Moon',
      'Waxing Crescent',
      'First Quarter',
      'Waxing Gibbous',
      'Full Moon',
      'Waning Gibbous',
      'Last Quarter',
      'Waning Crescent'
    ];

    // Update moon image + tooltip
    const now = new Date();
    const phaseIndex = getMoonPhaseIndex(now);
    const moonImg = document.getElementById('moon-img');
    moonImg.src = `https://royalbotics.github.io/cra/weather/sun-set-rise/${moonPhaseImages[phaseIndex]}`;
    moonImg.title = moonPhaseNames[phaseIndex];

    // Build current weather info object
    const currentInfo = {
      "Temperature": `${current.temperature} °C`,
      "Wind Speed": `${current.windspeed} km/h`,
      "Wind Direction": `${current.winddirection}°`,
      "Weather": (typeof weatherCodeMap !== 'undefined' && weatherCodeMap[current.weathercode]) || `Unknown (${current.weathercode})`,
      "UV Index (Max)": daily.uv_index_max[0],
      "Precipitation": `${daily.precipitation_sum[0]} mm`,
      "Sunrise": document.getElementById('sunrise-time').textContent,
      "Sunset": document.getElementById('sunset-time').textContent,
      "Apparent Temp. Max": `${daily.apparent_temperature_max[0]} °C`,
      "Apparent Temp. Min": `${daily.apparent_temperature_min[0]} °C`,
      "Wind Gusts Max": `${daily.windgusts_10m_max[0]} km/h`
    };

    // Display current info
    const infoEl = document.getElementById('current-info');
    infoEl.innerHTML = '';
    for (const [label, value] of Object.entries(currentInfo)) {
      infoEl.innerHTML += `
        <div class="info-label">${label}</div>
        <div class="info-value">${value}</div>`;
    }

    // Display daily forecast
    const forecastEl = document.getElementById('daily-forecast');
    forecastEl.innerHTML = '';
    for (let i = 0; i < daily.time.length; i++) {
      forecastEl.innerHTML += `
        <div class="forecast-day">
          <div class="label">${daily.time[i]}</div>
          <div class="value">${daily.temperature_2m_min[i]} - ${daily.temperature_2m_max[i]} °C</div>
          <div class="label">Rain: ${daily.precipitation_sum[i]} mm</div>
          <div class="label">UV Index: ${daily.uv_index_max[i]}</div>
          <div class="label">Wind Speed: ${daily.windspeed_10m_max ? daily.windspeed_10m_max[i] + ' km/h' : 'N/A'}</div>
        </div>`;
    }

    // Optional background update if you have this function
    if (typeof setWeatherBackground === "function") {
      setWeatherBackground(current.weathercode);
    }

  } catch (err) {
    document.getElementById('search-error').textContent = 'Error fetching weather data.';
    console.error(err);
  }
}
